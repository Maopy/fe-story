# 什么是作用域？

几乎所有编程语言最基本的功能之一，就是能够储存变量当中的值，并且能在之后对这个值进行访问或修改。那么：

* 这些变量存储在哪里？
* 程序需要时如何找到它们？

这些问题说明需要一套设计良好的规则来存储变量，并且之后可以方便地找到这些变量。 这套规则被称为**作用域**。

## 1.1 编译原理

尽管通常将 JavaScript 归类为“动态”或“解释执行”语言，但事实上它是一门**编译语言**。但与传统的编译语言不同，它**不是提前编译的**，编译结果也不能在分布式系统中进行移植。

在传统编译语言的流程中，程序中的一段源代码在执行之前会经历三个步骤，统称为“**编译**”。

* 分词/词法分析\(Tokenizing/Lexing\)：将由字符组成的字符串分解成\(对编程语言来说\)有意义的代码块，这些代码块被称为词法单元\(token\)。
* 解析/语法分析\(Parsing\)：将词法单元流\(数组\)转换成一个由元素逐级嵌套所组成的代表了程序语法 结构的树。这个树被称为“抽象语法树”\(Abstract Syntax Tree，AST\)。
* 代码生成：将 AST 转换为可执行代码的过程称被称为代码生成。这个过程与语言、目标平台等息 息相关。

比起那些编译过程只有三个步骤的语言的编译器，JavaScript 引擎要复杂得多。例如，在 语法分析和代码生成阶段有特定的步骤来对运行性能进行优化，包括对冗余元素进行优化 等。

首先，JavaScript 引擎不会有大量的\(像其他语言编译器那么多的\)时间用来进行优化，因 为与其他语言不同，JavaScript 的编译过程不是发生在构建之前的。对于 JavaScript 来说，大部分情况下编译发生在代码执行前的几微秒\(甚至更短!\)的时 间内。在我们所要讨论的作用域背后，JavaScript 引擎用尽了各种办法\(比如 JIT，可以延 迟编译甚至实施重编译\)来保证性能最佳。

## 1.2 理解作用域

### 1.2.1 演员表

* 引擎：从头到尾负责整个 JavaScript 程序的编译及执行过程。
* 编译器：负责语法分析及代码生成等。
* 作用域：负责收集并维护由所有声明的标识符\(变量\)组成的一系列查询，并实施一套非常严格的规则，确定当前执行的代码对这些标识符的访问权限。

### 1.2.2 对话

当你看见 var a = 2; 这段程序时，很可能认为这是一句声明。事实上，引擎认为这里有两个完全不同的声明，一个由编译器在编译时处理，另一个则由引擎在运行时处理。

“为一个变量分配内存，将其命名为 a，然后将值 2 保存进这个变量。”然而，这并不完全正确。事实上变量的赋值操作会执行两个动作，首先编译器会在当前作用域中声明一个变量\(如 果之前没有声明过\)，然后在运行时引擎会在作用域中查找该变量，如果能够找到就会对它赋值。

### 1.2.3 编译器有话说

引擎执行编译器生成的代码时，会通过查找变量 a 来判断它是否已声明过。查找的过程由作用域进行协助，但是引擎执行怎样的查找，会影响最终的查找结果。

* LHS：找到变量的容器本身，然后对其赋值，赋值操作的目标是谁
* RHS：谁是赋值操作的源头



